<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invol√∫crate con tu comunidad</title>
  <style>
    :root{--green:#4caf50;}
    body {margin:0;font-family:'Segoe UI', Tahoma, sans-serif;background:#121212;color:#e0e0e0;}
    header {background:#1e1e1e;padding:15px 10%;display:flex;justify-content:space-between;align-items:center;color:var(--green);}
    a {color:inherit;text-decoration:none;}
    .container {display:flex;height:calc(100vh - 70px);}
    .list {width:40%;overflow-y:auto;padding:20px;background:#1a1a1a;}
    .list h1 {text-align:center;margin-bottom:20px;color:var(--green);}
    .pill {background:#2a2a2a;border:1px solid var(--green);border-radius:20px;padding:15px;margin-bottom:15px;cursor:pointer;transition:.3s;}
    .pill:hover {background:var(--green);color:#fff;}
    .pill h3 {margin:0 0 5px;}
    .pill p {margin:0 0 5px;font-size:.9rem;color:#bbb;}
    .pill span {font-weight:bold;color:#ccc;}
    .pill a {display:block;font-size:.85rem;color:#9cf;margin-top:5px;}
    #map {flex:1;height:100%;}
    .notice{font-size:.9rem;color:#ccc;margin:10px 0 0;text-align:center;}
  </style>
</head>
<body>
  <header>
    <div><a href="index.html">‚¨Ö Volver al inicio</a></div>
    <div>ANCY</div>
  </header>
  <div class="container">
    <div class="list">
      <h1>Invol√∫crate con tu comunidad</h1>
      <div id="placesList">Cargando instituciones...</div>
      <div class="notice">Si no ves resultados, revisa que tu API key tenga <b>billing</b> y <b>Places API</b> activados, y que est√©s sirviendo la p√°gina desde un dominio o localhost.</div>
    </div>
    <div id="map"></div>
  </div>

  <script>
    let map, service, markers=[], info;
    const seen = new Set();
    const placesData = [];
    const queries = [
      '"casa hogar" en Yucat√°n',
      'albergue en Yucat√°n',
      'DIF en Yucat√°n',
      'PRODENNAY en Yucat√°n',
      'orfanato en Yucat√°n',
      'asistencia social en M√©rida'
    ];

    function initMap() {
      const merida = {lat:20.967370, lng:-89.592586};
      map = new google.maps.Map(document.getElementById("map"), {
        center: merida, zoom: 12
      });
      service = new google.maps.places.PlacesService(map);
      info = new google.maps.InfoWindow();

      runQueriesSequential(0);
    }

    function runQueriesSequential(i){
      if(i >= queries.length){
        if(placesData.length===0){
          document.getElementById("placesList").innerHTML = "No se encontraron instituciones con los t√©rminos proporcionados.";
        }
        return;
      }
      const req = { query: queries[i] };
      service.textSearch(req, (results, status, pagination)=>{
        if(status === google.maps.places.PlacesServiceStatus.OK && results){
          results.forEach(p=>{
            if(!seen.has(p.place_id)){
              seen.add(p.place_id);
              placesData.push(p);
              addPlace(p);
            }
          });
          if(pagination && pagination.hasNextPage){
            setTimeout(()=>pagination.nextPage(), 1500);
          } else {
            runQueriesSequential(i+1);
          }
        } else {
          runQueriesSequential(i+1);
        }
      });
    }

    function addPlace(place){
      const marker = new google.maps.Marker({ map, position: place.geometry.location, title: place.name });
      markers.push(marker);
      marker.addListener('click', ()=>{
        info.setContent('<div style="max-width:220px"><strong>'+place.name+'</strong><br>'+ (place.formatted_address||'') + '</div>');
        info.open(map, marker);
      });

      const list = document.getElementById("placesList");
      if(list.textContent.includes("Cargando")) list.textContent = "";
      const div = document.createElement("div");
      div.className = "pill";
      div.onclick = () => {
        map.panTo(place.geometry.location);
        map.setZoom(15);
        google.maps.event.trigger(marker, 'click');
        marker.setAnimation(google.maps.Animation.BOUNCE);
        setTimeout(()=>marker.setAnimation(null), 1200);
      };
      const pDesc = guessDescription(place.types);
      div.innerHTML = `
        <h3>${place.name}</h3>
        <p>${pDesc}</p>
        <p>${place.formatted_address || "Direcci√≥n no disponible"}</p>
        <span>üìû Buscando...</span>
      `;
      list.appendChild(div);

      service.getDetails({placeId: place.place_id, fields:["name","formatted_address","formatted_phone_number","international_phone_number","website","url","types"]}, det=>{
        if(!det) return;
        const phone = det.formatted_phone_number || det.international_phone_number;
        div.querySelector("span").textContent = "üìû " + (phone || "No disponible");
        if(det.website){
          const link = document.createElement("a");
          link.href = det.website;
          link.target="_blank";
          link.rel="noopener";
          link.textContent = "üåê Sitio / Redes";
          div.appendChild(link);
        } else if(det.url){
          const link = document.createElement("a");
          link.href = det.url;
          link.target="_blank";
          link.rel="noopener";
          link.textContent = "üìç Ver en Google Maps";
          div.appendChild(link);
        }
      });
    }

    function guessDescription(types){
      if(!types || !types.length) return "Instituci√≥n de apoyo/servicio social en Yucat√°n.";
      const mapTypes = {
        'local_government_office':'Oficina de gobierno/servicios sociales.',
        'school':'Instituci√≥n educativa con programas de apoyo.',
        'church':'Organizaci√≥n comunitaria/fe con asistencia.',
        'point_of_interest':'Punto de inter√©s de asistencia/servicio.',
        'establishment':'Organizaci√≥n establecida de asistencia.',
        'charity':'Organizaci√≥n ben√©fica.',
        'non_profit':'Organizaci√≥n sin fines de lucro.'
      };
      for(const t of types){ if(mapTypes[t]) return mapTypes[t]; }
      return "Instituci√≥n de apoyo/servicio social en Yucat√°n.";
    }
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC1wZy8Nsu-ciITuSn1IahgCzWB4-NXpo0&libraries=places&language=es&region=MX&callback=initMap"></script>
</body>
</html>
